// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model posted_products {
  id           Int      @id @default(autoincrement())
  item_id      BigInt   @unique
  product_name String?
  price        Decimal? @db.Decimal(12,2)
  category_id  Int?
  posted_at    DateTime @default(now())
}

// Configurações específicas do usuário / conta (se for multi-tenant)
// Por enquanto, user_identifier pode ser 'default' para um único admin
model user_settings {
  id                  Int      @id @default(autoincrement())
  user_identifier     String   @unique // Ex: 'default'
  min_price           Decimal? @db.Decimal(12,2)
  max_price           Decimal? @db.Decimal(12,2)
  min_commission_rate Decimal? @db.Decimal(5,2) // Ex: 2.5 (representa 2.5%)
  max_commission_rate Decimal? @db.Decimal(5,2) // Ex: 15.0 (representa 15.0%)
  items_per_page      Int?     @default(100) // Quantidade de itens por página na busca da Shopee
  max_pages_per_run   Int?     @default(5)   // Máximo de páginas a buscar por execução
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
}

// Tabela para registrar cada clique nos seus links de afiliado
model click_event {
  id            Int      @id @default(autoincrement())
  item_id       BigInt?             // ID do item Shopee (se souber)
  short_hash    String?             // Hash do seu shortlink
  referer       String?             // De onde o clique veio
  user_agent    String?             // Navegador/dispositivo
  ip            String?             // IP do usuário
  source        String?             // 'facebook', 'instagram', 'whatsapp', 'telegram', etc.
  created_at    DateTime @default(now())
}

// Relatório de conversão validado recebido da Shopee
model validated_report {
  id                 Int      @id @default(autoincrement())
  conversion_id      BigInt   @unique
  purchase_time      DateTime
  click_time         DateTime?
  total_commission   Decimal? @db.Decimal(12,2) // Comissão total da conversão
  buyer_type         String?  // 'New' ou 'Existing'
  utm_content        String?  // Sub ID usado no link de afiliado
  orders             Json     // JSON com a lista de pedidos (para referência)
  created_at         DateTime @default(now())

  items validated_report_item[] // Relação com os itens do pedido
}

// Itens individuais dentro de um pedido de um relatório validado
model validated_report_item {
  id                      Int      @id @default(autoincrement())
  validated_report_id     Int
  order_id                String?
  item_id                 BigInt
  item_name               String?
  item_price              Decimal? @db.Decimal(12,2)
  qty                     Int?
  item_total_commission   Decimal? @db.Decimal(12,2) // Comissão do item
  created_at              DateTime @default(now())

  validated_report        validated_report @relation(fields: [validated_report_id], references: [id], onDelete: Cascade)
}

// Mapeamento de shortlinks para URLs de destino
model short_links {
  id          Int      @id @default(autoincrement())
  hash        String   @unique // Hash curto para o link (ex: 'abc12')
  target_url  String   // URL completa da Shopee
  item_id     BigInt?  // Opcional: ID do item Shopee associado
  created_at  DateTime @default(now())
}

// Categorias da Shopee que o admin escolheu monitorar
model monitored_category {
  id        Int      @id @default(autoincrement())
  cat_id    Int      @unique // ID da categoria na Shopee
  name      String?  // Nome da categoria (ex: 'Ração para Cães')
  active    Boolean  @default(true)
  priority  Int      @default(0) // Para ordenar a busca
  created_at DateTime @default(now())
}

// Log de cada execução do endpoint /api/send-offer
model execution_log {
  id             Int      @id @default(autoincrement())
  run_at         DateTime @default(now())
  status         String   // 'success', 'error', 'no_offer_found'
  item_id        BigInt?  // ID do item enviado (se houver)
  total_requests Int      // Quantidade de requisições feitas à Shopee
  details        Json?    // Detalhes adicionais (ex: mensagem de erro)
}